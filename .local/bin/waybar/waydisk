#!/bin/sh

t=0

toggle() {
	t=$(((t + 1) % 2))
	[ -z $spid ] || kill $spid
}

awk_tooltip_str='{printf "%s\t %.2fGB/%.2fGB\t %.1f%\n", $6, $3/1024000, $2/1024000, $3*100/$2}'

trap "toggle" USR1

print () {
	sizes="$(df -P --type=ext4 --type=btrfs | tail  -n +2)"
	if [ $t -eq 0 ]; then
		text=$(echo "$sizes" | awk '$6 == "/" {printf "%.f%\n", $3*100/$2}')
	else 
		text=$(echo "$sizes" | awk '$6 == "/" {printf "%.fGB/%.fGB", $3/1024000, $2/1024000}')
	fi

	tooltip=$(echo "$sizes" | awk "$awk_tooltip_str" | column -tc2 | sed ':a;N;$!ba;s/\n/\\n/g')
	printf '{"text": "%s", "tooltip": "%s", "class": "%s"}\n' "$text" "$tooltip" "default"
}

while true; do
	print
	sleep 5 &
	spid=$!
	wait
done
